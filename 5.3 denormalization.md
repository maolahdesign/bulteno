# 反正規化（Denormalization）
是關聯式資料庫設計中一種**故意違反正規化**原則的技術，通常用於**提升查詢性能**或**簡化數據結構**。以下是幾個關聯式資料庫反正規化的範例，針對不同場景設計，並以條列式呈現。每個範例包括正規化版本與反正規化版本的對比，以及應用情境。

---

### **範例 1：訂閱制雜誌公司的客戶與訂閱資料**
- **正規化版本**：
  - **客戶表 (Customers)**：
    ```
    customer_id | name    | email
    ------------|---------|------------------
    C001        | Alice   | alice@example.com
    C002        | Bob     | bob@example.com
    ```
  - **訂閱表 (Subscriptions)**：
    ```
    subscription_id | customer_id | magazine_id | start_date
    ----------------|-------------|-------------|------------
    S001            | C001        | M001        | 2023-01-01
    S002            | C002        | M002        | 2023-02-01
    ```
  - **雜誌表 (Magazines)**：
    ```
    magazine_id | title       | price
    ------------|-------------|-------
    M001        | 科技月刊    | 100
    M002        | 旅遊年刊    | 500
    ```
- **反正規化版本**：
  - **客戶訂閱表 (CustomerSubscriptions)**：
    ```
    customer_id | name    | email             | magazine_title | start_date | price
    ------------|---------|-------------------|----------------|------------|-------
    C001        | Alice   | alice@example.com | 科技月刊       | 2023-01-01 | 100
    C002        | Bob     | bob@example.com   | 旅遊年刊       | 2023-02-01 | 500
    ```
- **情境**：客戶查詢訂閱詳情時需頻繁聯結三表，影響性能。反正規化將資料合併為單表，減少 JOIN 操作。
- **優點**：查詢速度提升。
- **缺點**：數據冗餘（如 `name`、`price` 重複），更新雜誌價格時需同步修改多行。

---

### **範例 2：電子商務的訂單與產品資料**
- **正規化版本**：
  - **訂單表 (Orders)**：
    ```
    order_id | customer_id | order_date
    ---------|-------------|------------
    O001     | C001        | 2023-10-01
    ```
  - **訂單明細表 (OrderDetails)**：
    ```
    order_id | product_id | quantity | unit_price
    ---------|------------|----------|------------
    O001     | P001       | 2        | 50
    O001     | P002       | 1        | 30
    ```
  - **產品表 (Products)**：
    ```
    product_id | product_name | price
    -----------|--------------|-------
    P001       | T-shirt      | 50
    P002       | Cap          | 30
    ```
- **反正規化版本**：
  - **訂單總表 (OrderSummary)**：
    ```
    order_id | customer_id | order_date | product_name | quantity | unit_price
    ---------|-------------|------------|--------------|----------|------------
    O001     | C001        | 2023-10-01 | T-shirt      | 2        | 50
    O001     | C001        | 2023-10-01 | Cap          | 1        | 30
    ```
- **情境**：報表系統需頻繁查詢訂單明細與產品名稱，JOIN 操作耗時。反正規化將產品名稱併入訂單表。
- **優點**：簡化查詢，適合讀多寫少的場景。
- **缺點**：產品名稱變更時需更新多筆記錄，增加維護成本。

---

### **範例 3：學生選課系統的課程與成績**
- **正規化版本**：
  - **學生表 (Students)**：
    ```
    student_id | name
    -----------|------
    S001       | Alice
    ```
  - **課程表 (Courses)**：
    ```
    course_id | title
    ----------|----------
    C001      | 資料庫
    ```
  - **選課表 (Enrollments)**：
    ```
    enrollment_id | student_id | course_id | grade
    --------------|------------|-----------|-------
    E001          | S001       | C001      | A
    ```
- **反正規化版本**：
  - **學生選課表 (StudentEnrollments)**：
    ```
    student_id | name  | course_title | grade
    -----------|-------|--------------|-------
    S001       | Alice | 資料庫       | A
    ```
- **情境**：教師需要快速查看學生選課與成績報表，JOIN 操作頻繁且影響效率。
- **優點**：減少查詢複雜度，適合報表生成。
- **缺點**：課程名稱變更需更新所有相關記錄，數據一致性風險增加。

---

### **範例 4：銷售系統的客戶與地址**
- **正規化版本**：
  - **客戶表 (Customers)**：
    ```
    customer_id | name
    ------------|------
    C001        | Alice
    ```
  - **地址表 (Addresses)**：
    ```
    address_id | customer_id | city    | street
    -----------|-------------|---------|---------
    A001       | C001        | Taipei  | Zhongshan Rd
    ```
- **反正規化版本**：
  - **客戶地址表 (CustomerAddresses)**：
    ```
    customer_id | name  | city   | street
    ------------|-------|--------|---------
    C001        | Alice | Taipei | Zhongshan Rd
    ```
- **情境**：客戶資料查詢頻繁，地址很少更新，JOIN 成本高。
- **優點**：單表查詢更高效。
- **缺點**：若客戶有多個地址，會增加冗餘或需調整設計。

---

### **總結與應用場景**
- **反正規化的目的**：
  - 提升查詢性能（減少 JOIN）。
  - 簡化數據結構（適合特定應用）。
- **常見應用**：
  - 數據倉庫（Data Warehouse）：重視讀取速度。
  - 報表系統：減少複雜查詢。
  - 快取層：臨時儲存熱門數據。
- **注意事項**：
  - 增加數據冗餘，可能導致更新異常。
  - 需權衡寫入頻率與查詢需求。
